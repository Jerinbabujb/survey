{% extends 'admin/base.html' %}
{% block content %}

<!-- Alerts -->
{% if imported %}
<div class="mb-6 rounded-xl border border-green-300 bg-green-50 px-6 py-4 text-green-800 shadow-md">
  <div class="flex items-start justify-between">
    <div>
      <h3 class="text-lg font-bold">Import Successful</h3>
      <p class="text-sm mt-1">
        {{ added }} employees imported
        {% if skipped and skipped > 0 %}
          · {{ skipped }} rows skipped
        {% endif %}
      </p>
      <p class="text-sm mt-1 font-medium">
        Please send invites.
      </p>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="text-green-700 hover:text-green-900 text-xl font-bold leading-none">&times;</button>
  </div>
  <div class="mt-4">
    <form method="post" action="/admin/send-invites">
      <button class="bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-[#9c8f5f] transition-colors">Send Invites Now</button>
    </form>
  </div>
</div>
{% endif %}

{% if added_single %}
<div class="mb-6 rounded-xl border border-green-300 bg-green-50 px-6 py-4 text-green-800 shadow-md">
  <div class="flex items-start justify-between">
    <div>
      <h3 class="text-lg font-bold">Employee Added</h3>
      <p class="text-sm mt-1">
        Employee added successfully.
      </p>
      <p class="text-sm mt-1 font-medium">
        Please send invite.
      </p>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="text-green-700 hover:text-green-900 text-xl font-bold">&times;</button>
  </div>
  <div class="mt-4">
    <form method="post" action="/admin/send-invites">
      <button class="bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-[#9c8f5f] transition-colors">Send Invite Now</button>
    </form>
  </div>
</div>
{% endif %}

{% if invited %}
<div class="mb-6 rounded-xl border border-blue-300 bg-blue-50 px-6 py-4 text-blue-800 shadow-md">
  <div class="flex justify-between items-start">
    <div>
      <h3 class="text-lg font-bold">Invites Sent</h3>
      <p class="text-sm mt-1">
        {{ invited_count or 0 }} employees invited successfully
        {% if skipped and skipped > 0 %}
          · {{ skipped }} skipped
        {% endif %}
      </p>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="text-blue-700 hover:text-blue-900 text-xl font-bold">&times;</button>
  </div>
</div>
{% endif %}

{% if reminded %}
<div class="mb-6 rounded-xl border border-purple-300 bg-purple-50 px-6 py-4 text-purple-800 shadow-md">
  <div class="flex justify-between items-start">
    <div>
      <h3 class="text-lg font-bold">Reminders Sent</h3>
      <p class="text-sm mt-1">
        {{ invited_count or 0 }} reminders sent successfully
      </p>
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="text-purple-700 hover:text-purple-900 text-xl font-bold">&times;</button>
  </div>
</div>
{% endif %}

<!-- Employee Forms (Add + Bulk Import + Bulk Email) -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

  <!-- Add Employee -->
  <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300">
    <h2 class="text-xl font-bold mb-4">Add Employee</h2>
    <form method="post" action="/admin/employees/add" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input type="text" name="name" required class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Email</label>
        <input type="email" name="email" required class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Department</label>
        <input type="text" name="department" required class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Position</label>
        <input type="text" name="position" required class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Survey Names</label>
        <div id="survey-container" class="space-y-2">
          <input type="text" name="survey_names" required placeholder="Survey Name" class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
        </div>
        <button type="button" onclick="addSurveyField()" class="mt-2 text-sm text-blue-600 hover:underline">+ Add another survey</button>
      </div>
      <button class="w-full bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-[#9c8f5f] transition-colors">Add Employee</button>
    </form>
  </div>

  <script>
    function addSurveyField() {
      const container = document.getElementById("survey-container");
      const input = document.createElement("input");
      input.type = "text";
      input.name = "survey_names";
      input.placeholder = "Survey Name";
      input.required = true;
      input.className = "w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400";
      container.appendChild(input);
    }
  </script>

  <!-- Bulk Import -->
  <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300">
    <h2 class="text-xl font-bold mb-4">Bulk Import (CSV)</h2>
    <form id="csvForm" method="post" action="/admin/employees/import" enctype="multipart/form-data" class="space-y-4">
      <label class="block text-sm font-medium mb-1">Paste CSV (optional)</label>
      <textarea name="csv_rows" rows="6" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Name,Email,Department,Survey Names (comma-separated),Position"></textarea>
      <div class="text-center text-gray-500 font-semibold">OR</div>
      <label class="block text-sm font-medium mb-1">Upload CSV File (optional)</label>
      <input type="file" name="csv_file" accept=".csv" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
      <div id="csvAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-md text-sm">
        Please provide either CSV text or upload a CSV file.
      </div>
      <button type="submit" class="w-full bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-[#9c8f5f] transition-colors">Import Employees</button>
      <a href="/static/import.csv" download class="block mt-2">
        <button type="button" class="w-full flex items-center justify-center gap-2 bg-black text-white border border-gray-300 font-medium px-4 py-2 rounded-md shadow transition-colors hover:shadow-md">Download Sample CSV</button>
      </a>
      <p class="text-xs text-gray-500 mt-2">CSV columns: Name, Email, Department, Survey Names (comma-separated), Position</p>
    </form>
    <script>
      document.getElementById('csvForm').addEventListener('submit', function(e) {
        const textarea = this.querySelector('textarea[name="csv_rows"]');
        const fileInput = this.querySelector('input[name="csv_file"]');
        const alertBox = document.getElementById('csvAlert');
        if (!textarea.value.trim() && !fileInput.files.length) {
          e.preventDefault();
          alertBox.classList.remove('hidden');
        } else {
          alertBox.classList.add('hidden');
        }
      });
    </script>
  </div>

  <!-- Bulk Email -->
  <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300 space-y-4">
    <h2 class="text-xl font-bold mb-4">Bulk Email</h2>
    <form method="post" action="/admin/send-invites">
      <button class="w-full bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-[#9c8f5f] transition-colors">Send Invites</button>
    </form>
    <form method="post" action="/admin/send-reminders">
      <button class="w-full bg-black text-white px-4 py-2 rounded-md hover:bg-[#000] transition-colors">Send Reminders</button>
    </form>
  </div>
</div>

<!-- Employees List -->
<div class="space-y-6">
{% for employee in employees %}
<div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300 mb-4">

  <!-- Employee Info -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
    <div>
      {% if not employee.submitted_at %}
        <h3 class="text-lg font-semibold">{{ employee.name }}</h3>
        <p class="text-sm text-gray-500">{{ employee.email }}</p>
      {% else %}
        <h3 class="text-lg font-semibold">****</h3>
        <p class="text-sm text-gray-500">***@{{ employee.email.split('@')[1] }}</p>
      {% endif %}
      <p class="text-sm mt-1">
        <span class="font-medium">Department:</span> {{ employee.department }} ·
        <span class="font-medium">Position:</span> {{ employee.position }}
      </p>
      <p class="text-sm mt-1">
        {% if not employee.is_active %}
          <span class="text-gray-400 font-medium">Inactive</span>
        {% elif employee.submitted_at %}
          <span class="text-green-600 font-semibold">Submitted</span>
        {% else %}
          <span class="text-amber-600 font-semibold">Pending</span>
        {% endif %}
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Invited: {{ employee.invited_at.strftime("%Y-%m-%d %H:%M") if employee.invited_at else "—" }}  
        | Submitted: {{ employee.submitted_at.strftime("%Y-%m-%d %H:%M") if employee.submitted_at else "—" }}
      </p>
    </div>
    <div class="flex space-x-2 mt-2 md:mt-0">
      <form method="post" action="/admin/employees/{{ employee.id }}/toggle">
        <button class="text-blue-600 hover:underline disabled:opacity-50" {{ 'disabled' if employee.submitted_at else '' }}>
          {{ 'Activate' if not employee.is_active else 'Deactivate' }}
        </button>
      </form>
      {% if employee.is_active %}
      <form method="post" action="/admin/employees/{{ employee.id }}/resend">
        <button class="text-amber-600 hover:underline disabled:opacity-50" {{ 'disabled' if employee.submitted_at else '' }}>
          Send Invite
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Submissions by Survey -->
  {% for survey_name, survey_data in employee.submissions_by_survey.items() %}
  <div class="mt-4">
    <h4 class="text-lg font-semibold mb-2">{{ survey_name }}</h4>
    <table class="w-full border border-gray-200 rounded-md text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-3 py-2 text-left">Question</th>
          <th class="px-3 py-2 text-center">Score</th>
          <th class="px-3 py-2 text-center">Category</th>
        </tr>
      </thead>
      <tbody>
        {% for q in survey_data.question_scores %}
        <tr class="border-t">
          <!-- Question with hover tooltip -->
          <td class="px-3 py-2 relative group">
            <span class="cursor-pointer font-medium text-blue-600">Q{{ q.question_no }}</span>
            <div class="absolute left-0 top-full mt-2 w-96
                        bg-white border border-gray-200 rounded-lg shadow-xl
                        text-sm text-gray-700 p-4
                        opacity-0 invisible
                        group-hover:opacity-100 group-hover:visible
                        transition-all duration-200 ease-out z-50">
              {{ q.question }}
            </div>
          </td>
          <td class="px-3 py-2 text-center font-medium">{{ q.score }}</td>
          <td class="px-3 py-2 text-center font-medium">
            {% if q.category == "Outstanding" %}
              <span class="text-green-700 font-semibold">{{ q.category }}</span>
            {% elif q.category == "Exceeds Target" %}
              <span class="text-blue-600 font-semibold">{{ q.category }}</span>
            {% elif q.category == "Meets Target" %}
              <span class="text-yellow-600 font-semibold">{{ q.category }}</span>
            {% else %}
              <span class="text-red-600 font-semibold">{{ q.category }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}

</div>
{% else %}
<p class="text-center text-gray-500">No employees found.</p>
{% endfor %}
</div>

{% endblock %}
