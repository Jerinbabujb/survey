{% extends 'admin/base.html' %}
{% block content %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
  <!-- Add Employee -->
  <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300">
    <h2 class="text-xl font-bold mb-4">Add Employee</h2>
    <form method="post" action="/admin/employees/add" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input type="text" name="name" required class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Email</label>
        <input type="email" name="email" required class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Department</label>
        <input type="text" name="department" required class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
      </div>
      <button class="w-full bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">Add Employee</button>
    </form>
  </div>

<div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300">
  <h2 class="text-xl font-bold mb-4">Bulk Import (CSV)</h2>

  <form id="csvForm" method="post" action="/admin/employees/import" enctype="multipart/form-data" class="space-y-4">

    <!-- Paste CSV -->
    <textarea
      name="csv_rows"
      rows="6"
      class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
      placeholder="Name,Email,department"></textarea>

    <div class="text-center text-gray-500 font-semibold">OR</div>

    <!-- Upload CSV -->
    <input
      type="file"
      name="csv_file"
      accept=".csv"
      class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />

    <!-- Alert box -->
    <div id="csvAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-md text-sm">
      Please provide either CSV text or upload a CSV file.
    </div>

    <button
      type="submit"
      class="w-full bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
      Import CSV
    </button>

    <a href="/static/import.csv" download class="block">
      <button
        type="button"
        class="w-full flex items-center justify-center gap-2 bg-black text-white border border-gray-300 text-gray-700 font-medium px-4 py-2 rounded-md shadow hover:bg-gray-100 transition-colors hover:shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v4h16v-4M12 12v8m0-8l-4 4m4-4l4 4"/>
        </svg>
        Download Sample CSV
      </button>
    </a>

  </form>
</div>

<script>
document.getElementById('csvForm').addEventListener('submit', function(e) {
  const textarea = this.querySelector('textarea[name="csv_rows"]');
  const fileInput = this.querySelector('input[name="csv_file"]');
  const alertBox = document.getElementById('csvAlert');

  if (!textarea.value.trim() && !fileInput.files.length) {
    e.preventDefault(); // prevent form submission
    alertBox.classList.remove('hidden'); // show alert
  } else {
    alertBox.classList.add('hidden'); // hide alert if form is valid
  }
});
</script>



  <!-- Bulk Email -->
  <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300 space-y-4">
    <h2 class="text-xl font-bold mb-4">Bulk Email</h2>
    <form method="post" action="/admin/send-invites">
      <button class="w-full bg-[#ad9f6f] text-white px-4 py-2 rounded-md hover:bg-[#ad9f6f] transition-colors">Send Invites</button>
    </form>
    <form method="post" action="/admin/send-reminders">
      <button class="w-full bg-black text-white px-4 py-2 rounded-md hover:bg-[#000] transition-colors">Send Reminders</button>
    </form>
  </div>
</div>

<!-- Employees List -->
<div class="space-y-6">
  {% for employee in employees %}
  <div class="bg-white shadow-lg rounded-xl p-6 hover:shadow-xl transition-shadow duration-300">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
      <div>
      {% if not employee.submitted_at %}
      <h3 class="text-lg font-semibold">{{ employee.name }}</h3>
  <p class="text-sm text-gray-500">{{ employee.email }}</p>
{% else %}
  <!-- Masked name -->
  <h3 class="text-lg font-semibold">
    ****
  </h3>
  <!-- Masked email -->
  <p class="text-sm text-gray-500">
    ***@{{ employee.email.split('@')[1] }}
  </p>
{% endif %}

        <p class="text-sm mt-1">
          {% if not employee.is_active %}
            <span class="text-gray-400 font-medium">Inactive</span>
          {% elif employee.submitted_at %}
            <span class="text-green-600 font-semibold">Submitted</span>
          {% else %}
            <span class="text-amber-600 font-semibold">Pending</span>
          {% endif %}
        </p>
        <p class="text-xs text-gray-500 mt-1">
          Invited: {{ employee.invited_at.strftime("%Y-%m-%d %H:%M") if employee.invited_at else "—" }}  
          | Submitted: {{ employee.submitted_at.strftime("%Y-%m-%d %H:%M") if employee.submitted_at else "—" }}
        </p>
      </div>
      <div class="flex space-x-2 mt-2 md:mt-0">
  <form method="post" action="/admin/employees/{{ employee.id }}/toggle">
    <button 
      class="text-blue-600 hover:underline disabled:opacity-50" 
      {{ 'disabled' if employee.submitted_at else '' }}
    >
      {{ 'Activate' if not employee.is_active else 'Deactivate' }}
    </button>
  </form>

  {% if employee.is_active %}
  <form method="post" action="/admin/employees/{{ employee.id }}/resend">
    <button 
      class="text-amber-600 hover:underline disabled:opacity-50" 
      {{ 'disabled' if employee.submitted_at else '' }}
    >
      Send Invite
    </button>
  </form>
  {% endif %}
</div>

    </div>

    {% if employee.question_scores %}
    <div class="overflow-x-auto mt-4">
      <table class="w-full border border-gray-200 rounded-md text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Question</th>
            <th class="px-3 py-2 text-center">Score</th>
            <th class="px-3 py-2 text-center">Category</th>
          </tr>
        </thead>
        <tbody>
          {% for q in employee.question_scores %}
          <tr class="border-t">
               <td class="px-3 py-2">
              <div class="relative inline-block group">

                <!-- Question Tab -->
                <span class="cursor-pointer font-medium text-blue-600">
                  Q{{ q.question_no }}
                </span>

                <!-- Hover Panel -->
                {% if questions is defined and q.question_no - 1 < questions|length %}
                <div
                  class="absolute left-0 top-full mt-2 w-96
                         bg-white border border-gray-200 rounded-lg shadow-xl
                         text-sm text-gray-700 p-4
                         opacity-0 invisible
                         group-hover:opacity-100 group-hover:visible
                         transition-all duration-200 ease-out
                         z-50"
                >
                  {{ questions[q.question_no - 1] }}
                </div>
                {% endif %}

              </div>
            </td>

            <td class="px-3 py-2 text-center font-medium">{{ q.score }}</td>
            <td class="px-3 py-2 text-center font-medium relative group">
  {% if q.category == "Outstanding" %}
    <span class="text-green-700 font-semibold cursor-pointer">{{ q.category }}</span>
  {% elif q.category == "Exceeds Target" %}
    <span class="text-blue-600 font-semibold cursor-pointer">{{ q.category }}</span>
  {% elif q.category == "Meets Target" %}
    <span class="text-yellow-600 font-semibold cursor-pointer">{{ q.category }}</span>
  {% else %}
    <span class="text-red-600 font-semibold cursor-pointer">{{ q.category }}</span>
  {% endif %}

  <!-- Hover Tooltip -->
  <div
    class="absolute left-1/2 transform -translate-x-1/2 top-full mt-2 w-96
           bg-white border border-gray-200 rounded-lg shadow-xl
           text-sm text-gray-700 p-4
           opacity-0 invisible
           group-hover:opacity-100 group-hover:visible
           transition-all duration-200 ease-out
           z-50"
  >
    {{ q.score_category }}
  </div>
</td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
  {% else %}
  <p class="text-center text-gray-500">No employees found.</p>
  {% endfor %}
</div>

{% endblock %}
